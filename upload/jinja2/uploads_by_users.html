{% extends 'layout.html' %}
{% import 'macros.html' as macros %}

{% block title %}Uploads{% endblock %}

{% block contents %}
<h2>Uploads (by students)</h2>

<p class="alert alert-info">Last update: {{ date(now) }}</p>

{% if uploads %}
<p>
{% for c in macros.allstatus -%}
<span class="{{ macros.status(c) }}"></span> {{ macros.statustxt(c) }}
{{ '&mdash;' | safe if not loop.last else '' }}
{% endfor %}
</p>

<div id="accordion">

{% for group in groups %}
{% set guploads=uploads[group] %}

<div class="card">
<div class="card-header" data-toggle="collapse"
     data-target="#collapse-{{ group }}">
  <h4 class="panel-title">
    <button class="btn btn-link">
    {% if group %}Group {{ group }}{% else %}Uncategorized{% endif %}
    </button>
  </h4>
</div>

<div id="collapse-{{ group }}" class="card-collapse collapse" data-parent="#accordion">
<div class="card-body">

<table class="table table-striped uploads">
<thead>
  <tr>
    <th>Name</th>
    {% for q in qst %}
    <th class="text-center">Q.{{ q }}</th>
    {% endfor %}
  </tr>
</thead>
<tbody>
{% for login in guploads.keys()|sort %}
{% set user   = users[login] %}
{% set upload = guploads[login] %}
  <tr>
    <td>{{ user.1 | truncate(20, True) }}</td>
    {% for q in qst %}
    <td class="text-center text-nowrap">
    {% if upload[q] %}
    <span class="{{ macros.status(upload[q].0.status) }}"></span>
    &nbsp;
    <span class="small olinks">
    <a target="_blank" href="{{ url('upload:download_upload', the.code, the.subcode, the.promo, login, q) }}">
      <i class="fa fa-download"></i>
    </a>
    <a target="_blank" href="{{ url('upload:upload_details_by_login', the.code, the.subcode, the.promo, login, q) }}">
      <i class="fa fa-arrow-circle-right"></i>
    </a>
    </span>
    {% endif %}
    </td>
    {% endfor %}
  </tr>
{% endfor %}
</tbody>
</table>

</div>
</div>
</div>
{% endfor %}

</div>
{% else %}
<div class="alert alert-warning">No uploads</div>
{% endif %}

<script type="text/javascript">
$(function() {
  $('.card-collapse').on('shown.bs.collapse', function () {
    var h = $(this).attr('id').match(/^collapse-(.+)$/);
    if (h != null) location.hash = h[1];
  });

  var mtch = window.location.hash.match(/^#(\d+|None)$/);

  if (mtch != null) {
    var tgt = $(('#collapse-' + mtch[1]) + '.collapse');

    tgt.collapse({ 'toggle': true, 'parent': '#accordion' });
    $('html, body').animate({ scrollTop: tgt.parent().offset().top }, 400);
  }
});
</script>

{% endblock %}
